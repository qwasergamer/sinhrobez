<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="icon" href="images/logo.ico"><!-- 32×32 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Активные заявки - Синхро-Безопасность</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Чердак -->
    <div class="top-bar">
        <div class="container">
            <div class="top-contacts">
                <div class="top-contact-item">
                    <i class="fas fa-phone"></i>
                    <span>+7 (919) 157-79-00</span>
                </div>
                <div class="top-contact-item">
                    <i class="fas fa-envelope"></i>
                    <span>vladimir_minkov@mail.ru</span>
                </div>
            </div>
            <a href="contacts.html#demo" class="top-cta">Заказать демо</a>
        </div>
    </div>

    <!-- Шапка -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <div class="logo-icon">СБ</div>
                    <div class="logo-text">
                        <h1>Синхро-Безопасность</h1>
                        <p class="tagline">Промышленная автоматизация контроля доступа</p>
                    </div>
                </a>
                <nav class="main-nav" id="mainNav">
                    <ul>
                        <li><a href="index.html"><i class="fas fa-home"></i>Главная</a></li>
                        <li><a href="about.html"><i class="fas fa-info-circle"></i>О продукте</a></li>
                        <li><a href="features.html"><i class="fas fa-star"></i>Возможности</a></li>
                        <li><a href="technology.html"><i class="fas fa-cogs"></i>Технологии</a></li>
                        <li><a href="requests.html" class="active"><i class="fas fa-database"></i>Заявки</a></li>
                    </ul>
                </nav>
                <button class="side-menu-btn" id="sideMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Боковое меню -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h3>Все разделы</h3>
            <button class="close-side-menu" id="closeSideMenu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="side-menu-nav">
            <ul>
                <li><a href="index.html"><i class="fas fa-home"></i>Главная</a></li>
                <li><a href="about.html"><i class="fas fa-info-circle"></i>О продукте</a></li>
                <li><a href="features.html"><i class="fas fa-star"></i>Возможности</a></li>
                <li><a href="technology.html"><i class="fas fa-cogs"></i>Технологии</a></li>
                <li><a href="requirements.html"><i class="fas fa-server"></i>Требования</a></li>
                <li><a href="installation.html"><i class="fas fa-download"></i>Установка</a></li>
                <li><a href="docs.html"><i class="fas fa-book"></i>Документация</a></li>
                <li><a href="contacts.html"><i class="fas fa-phone"></i>Контакты</a></li>
                <li><a href="download.html"><i class="fas fa-file-download"></i>Скачать</a></li>
                <li><a href="support.html"><i class="fas fa-headset"></i>Поддержка</a></li>
                <li><a href="integration.html"><i class="fas fa-link"></i>Интеграция</a></li>
                <li><a href="privacy.html"><i class="fas fa-shield-alt"></i>Политика</a></li>
                <li><a href="requests.html"><i class="fas fa-database"></i>Заявки</a></li>
            </ul>
        </nav>
    </div>

    <!-- Заголовок страницы -->
    <section class="page-header">
        <div class="container">
            <h1>Активные заявки</h1>
            <div class="breadcrumb">
                <a href="index.html">Главная</a> / <span>Заявки</span>
            </div>
        </div>
    </section>

    <!-- Содержимое страницы -->
    <section class="content-section">
        <div class="container">
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="color: var(--oil-dark); margin-bottom: 20px; font-size: 2rem;">
                    <i class="fas fa-database" style="color: var(--oil-gold); margin-right: 10px;"></i>
                    База данных заявок
                </h2>
                <p style="max-width: 800px; margin: 0 auto; font-size: 1.1rem; color: var(--oil-steel);">
                    Все заявки на демонстрацию и обращения в поддержку сохраняются локально в браузере
                </p>
            </div>

            <!-- Статистика -->
            <div style="background: var(--oil-light); padding: 30px; border-radius: 10px; margin-bottom: 40px;">
                <h3 style="color: var(--oil-dark); margin-bottom: 25px; text-align: center;">
                    <i class="fas fa-chart-bar" style="color: var(--oil-gold); margin-right: 10px;"></i>
                    Статистика
                </h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2.5rem; color: var(--oil-gold); margin-bottom: 10px;">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--oil-dark);" id="totalRequests">0</div>
                        <div style="color: var(--oil-steel);">Всего заявок</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2.5rem; color: var(--oil-blue); margin-bottom: 10px;">
                            <i class="fas fa-desktop"></i>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--oil-dark);" id="demoRequests">0</div>
                        <div style="color: var(--oil-steel);">Заявок на демо</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2.5rem; color: var(--oil-green); margin-bottom: 10px;">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--oil-dark);" id="supportRequests">0</div>
                        <div style="color: var(--oil-steel);">Обращений в поддержку</div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        <div style="font-size: 2.5rem; color: var(--oil-fire); margin-bottom: 10px;">
                            <i class="fas fa-calendar-day"></i>
                        </div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--oil-dark);" id="todayRequests">0</div>
                        <div style="color: var(--oil-steel);">Сегодня</div>
                    </div>
                </div>
            </div>

            <!-- Управление данными -->
            <div style="margin-bottom: 40px; text-align: center;">
                <button id="exportBtn" class="btn btn-primary" style="margin: 5px;">
                    <i class="fas fa-download"></i> Экспорт в Excel
                </button>
                <button id="importBtn" class="btn btn-primary" style="margin: 5px;">
                    <i class="fas fa-upload"></i> Импорт данных
                </button>
                <button id="clearBtn" class="btn btn-secondary" style="margin: 5px;">
                    <i class="fas fa-trash"></i> Очистить все данные
                </button>
                <button id="refreshBtn" class="btn btn-primary" style="margin: 5px;">
                    <i class="fas fa-sync"></i> Обновить
                </button>
            </div>

            <!-- Таблица заявок -->
            <div style="margin-bottom: 40px;">
                <h3 style="color: var(--oil-dark); margin-bottom: 25px; text-align: center;">
                    <i class="fas fa-list" style="color: var(--oil-gold); margin-right: 10px;"></i>
                    Все заявки
                </h3>
                
                <div style="overflow-x: auto;">
                    <table class="requests-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--oil-dark); color: white;">
                                <th style="padding: 15px; text-align: left;">ID</th>
                                <th style="padding: 15px; text-align: left;">Тип</th>
                                <th style="padding: 15px; text-align: left;">Дата</th>
                                <th style="padding: 15px; text-align: left;">Имя</th>
                                <th style="padding: 15px; text-align: left;">Компания</th>
                                <th style="padding: 15px; text-align: left;">Телефон</th>
                                <th style="padding: 15px; text-align: left;">Email</th>
                                <th style="padding: 15px; text-align: left;">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="requestsTableBody">
                            <!-- Сюда JavaScript добавит строки -->
                            <tr id="noRequestsRow">
                                <td colspan="8" style="padding: 30px; text-align: center; color: var(--oil-steel);">
                                    <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; color: var(--oil-light);"></i>
                                    Нет сохранённых заявок<br>
                                    <span style="font-size: 0.9rem;">Заявки появятся здесь после заполнения форм</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Детальный просмотр -->
            <div id="requestDetails" style="display: none; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 40px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <h3 style="color: var(--oil-dark); margin: 0;">
                        <i class="fas fa-file-alt" style="color: var(--oil-gold); margin-right: 10px;"></i>
                        Детали заявки #<span id="detailId">0</span>
                    </h3>
                    <button id="closeDetailsBtn" style="background: none; border: none; font-size: 1.5rem; color: var(--oil-steel); cursor: pointer;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="detailContent">
                    <!-- Сюда загрузится детальная информация -->
                </div>
            </div>

            <!-- Информация о сохранении -->
            <div style="background: var(--gradient-steel); color: white; padding: 25px; border-radius: 10px; text-align: center;">
                <h4 style="margin-bottom: 15px; color: var(--oil-white);">
                    <i class="fas fa-info-circle" style="color: var(--oil-gold); margin-right: 10px;"></i>
                    Как это работает?
                </h4>
                <p style="margin-bottom: 0; opacity: 0.9;">
                    Все заявки сохраняются в локальном хранилище браузера (LocalStorage).<br>
                    Данные доступны только с этого компьютера и в этом браузере.
                </p>
            </div>
        </div>
    </section>

    <!-- Подвал -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-col">
                    <h3>Синхро-Безопасность</h3>
                    <p>Профессиональное решение для автоматизации управления группами безопасности.</p>
                </div>
                <div class="footer-col">
                    <h3>Контакты</h3>
                    <ul class="footer-contact">
                        <li><i class="fas fa-phone"></i> +7 (919) 157-79-00</li>
                        <li><i class="fas fa-envelope"></i> vladimir_minkov@mail.ru</li>
                        <li><i class="fas fa-clock"></i> Пн-Пт: 9:00-18:00 МСК</li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h3>Навигация</h3>
                    <ul class="footer-links">
                        <li><a href="contacts.html"><i class="fas fa-file-alt"></i> Оставить заявку</a></li>
                        <li><a href="support.html"><i class="fas fa-headset"></i> Поддержка</a></li>
                        <li><a href="download.html"><i class="fas fa-download"></i> Скачать демо</a></li>
                        <li><a href="requests.html"><i class="fas fa-database"></i> База заявок</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; <span class="current-year">2025</span> Синхро-Безопасность. Все права защищены.</p>
                <p>Заявки сохраняются локально в браузере</p>
            </div>
        </div>
    </footer>

    <!-- Модальное окно подтверждения -->
    <div class="modal" id="confirmModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center;">
                <div style="width: 60px; height: 60px; background: var(--oil-fire); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 style="color: var(--oil-dark); margin-bottom: 15px;" id="confirmTitle">Подтверждение</h3>
                <p style="color: var(--oil-steel); margin-bottom: 25px;" id="confirmMessage"></p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="confirmCancelBtn" class="btn btn-secondary" style="padding: 10px 25px;">Отмена</button>
                    <button id="confirmOkBtn" class="btn btn-primary" style="padding: 10px 25px;">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно импорта -->
    <div class="modal" id="importModal">
        <div class="modal-content" style="max-width: 500px;">
            <div style="text-align: center;">
                <div style="width: 60px; height: 60px; background: var(--oil-blue); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; font-size: 30px;">
                    <i class="fas fa-file-import"></i>
                </div>
                <h3 style="color: var(--oil-dark); margin-bottom: 15px;">Импорт данных</h3>
                <p style="color: var(--oil-steel); margin-bottom: 20px;">
                    Выберите файл .json для импорта заявок
                </p>
                <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 20px; padding: 10px; border: 2px dashed #ddd; border-radius: 8px; width: 100%;">
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button id="importCancelBtn" class="btn btn-secondary" style="padding: 10px 25px;">Отмена</button>
                    <button id="importFileBtn" class="btn btn-primary" style="padding: 10px 25px;">Импортировать</button>
                </div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
    // ===== JavaScript для страницы заявок =====
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Страница заявок загружена');
        
        // Элементы
        const tableBody = document.getElementById('requestsTableBody');
        const noRequestsRow = document.getElementById('noRequestsRow');
        const requestDetails = document.getElementById('requestDetails');
        const detailContent = document.getElementById('detailContent');
        const detailId = document.getElementById('detailId');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        
        // Кнопки
        const exportBtn = document.getElementById('exportBtn');
        const importBtn = document.getElementById('importBtn');
        const clearBtn = document.getElementById('clearBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        
        // Модальные окна
        const confirmModal = document.getElementById('confirmModal');
        const importModal = document.getElementById('importModal');
        const importFileInput = document.getElementById('importFileInput');
        const importFileBtn = document.getElementById('importFileBtn');
        const importCancelBtn = document.getElementById('importCancelBtn');
        
        // Функция загрузки всех заявок
        function loadAllRequests() {
            console.log('Загрузка всех заявок...');
            
            // Загружаем оба типа заявок
            const demoRequests = JSON.parse(localStorage.getItem('sync_demo_requests') || '[]');
            const supportRequests = JSON.parse(localStorage.getItem('sync_support_requests') || '[]');
            
            console.log('Демо заявок:', demoRequests.length);
            console.log('Заявок поддержки:', supportRequests.length);
            
            // Объединяем и сортируем по дате (новые сверху)
            const allRequests = [...demoRequests, ...supportRequests]
                .sort((a, b) => new Date(b.timestamp || b.created_at) - new Date(a.timestamp || a.created_at));
            
            // Обновляем статистику
            updateStatistics(demoRequests.length, supportRequests.length);
            
            // Очищаем таблицу
            tableBody.innerHTML = '';
            
            if (allRequests.length === 0) {
                tableBody.appendChild(noRequestsRow.cloneNode(true));
                return;
            }
            
            // Скрываем строку "нет заявок"
            noRequestsRow.style.display = 'none';
            
            // Добавляем каждую заявку в таблицу
            allRequests.forEach((request, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                row.style.transition = 'background 0.3s';
                
                // При наведении
                row.addEventListener('mouseenter', () => {
                    row.style.background = 'var(--oil-light)';
                });
                row.addEventListener('mouseleave', () => {
                    row.style.background = '';
                });
                
                // Определяем тип заявки
                const isDemo = request.hasOwnProperty('users_count');
                const type = isDemo ? 'Демо' : 'Поддержка';
                const typeColor = isDemo ? 'var(--oil-blue)' : 'var(--oil-green)';
                const typeIcon = isDemo ? 'fa-desktop' : 'fa-headset';
                
                // Форматируем дату
                const date = new Date(request.timestamp || request.created_at);
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Создаем ячейки
                row.innerHTML = `
                    <td style="padding: 15px; color: var(--oil-steel); font-weight: bold;">
                        ${index + 1}
                    </td>
                    <td style="padding: 15px;">
                        <span style="display: inline-flex; align-items: center; gap: 5px; padding: 5px 10px; background: ${typeColor}; color: white; border-radius: 20px; font-size: 0.8rem;">
                            <i class="fas ${typeIcon}"></i> ${type}
                        </span>
                    </td>
                    <td style="padding: 15px; color: var(--oil-steel);">
                        ${formattedDate}
                    </td>
                    <td style="padding: 15px; font-weight: 500; color: var(--oil-dark);">
                        ${escapeHtml(request.full_name || request.name)}
                    </td>
                    <td style="padding: 15px; color: var(--oil-steel);">
                        ${escapeHtml(request.company)}
                    </td>
                    <td style="padding: 15px;">
                        <a href="tel:${request.phone}" style="color: var(--oil-blue); text-decoration: none;">
                            <i class="fas fa-phone" style="margin-right: 5px;"></i>${request.phone}
                        </a>
                    </td>
                    <td style="padding: 15px;">
                        <a href="mailto:${request.email}" style="color: var(--oil-blue); text-decoration: none;">
                            <i class="fas fa-envelope" style="margin-right: 5px;"></i>${request.email}
                        </a>
                    </td>
                    <td style="padding: 15px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="view-btn" data-index="${index}" data-type="${isDemo ? 'demo' : 'support'}" style="padding: 6px 12px; background: var(--oil-gold); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="delete-btn" data-index="${index}" data-type="${isDemo ? 'demo' : 'support'}" style="padding: 6px 12px; background: var(--oil-fire); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Добавляем обработчики кнопок
            addRowEventListeners();
        }
        
        // Функция обновления статистики
        function updateStatistics(demoCount, supportCount) {
            const total = demoCount + supportCount;
            const today = new Date().toDateString();
            
            // Подсчитываем заявки за сегодня
            let todayCount = 0;
            const demoRequests = JSON.parse(localStorage.getItem('sync_demo_requests') || '[]');
            const supportRequests = JSON.parse(localStorage.getItem('sync_support_requests') || '[]');
            
            [...demoRequests, ...supportRequests].forEach(request => {
                const requestDate = new Date(request.timestamp || request.created_at).toDateString();
                if (requestDate === today) {
                    todayCount++;
                }
            });
            
            // Обновляем элементы
            document.getElementById('totalRequests').textContent = total;
            document.getElementById('demoRequests').textContent = demoCount;
            document.getElementById('supportRequests').textContent = supportCount;
            document.getElementById('todayRequests').textContent = todayCount;
        }
        
        // Функция добавления обработчиков к строкам
        function addRowEventListeners() {
            // Кнопки просмотра
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const type = this.getAttribute('data-type');
                    showRequestDetails(index, type);
                });
            });
            
            // Кнопки удаления
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    const type = this.getAttribute('data-type');
                    showConfirmDelete(index, type);
                });
            });
        }
        
        // Функция показа деталей заявки
        function showRequestDetails(index, type) {
            const requests = JSON.parse(localStorage.getItem(`sync_${type}_requests`) || '[]');
            
            if (index >= 0 && index < requests.length) {
                const request = requests[index];
                const isDemo = type === 'demo';
                
                detailId.textContent = index + 1;
                
                // Форматируем дату
                const date = new Date(request.timestamp || request.created_at);
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Создаем HTML для деталей
                let detailsHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div>
                            <h4 style="color: var(--oil-dark); margin-bottom: 10px; border-bottom: 2px solid var(--oil-light); padding-bottom: 5px;">
                                <i class="fas fa-user" style="color: var(--oil-gold); margin-right: 8px;"></i>
                                Контактная информация
                            </h4>
                            <p><strong>Имя:</strong> ${escapeHtml(request.full_name || request.name)}</p>
                            <p><strong>Компания:</strong> ${escapeHtml(request.company)}</p>
                            ${request.position ? `<p><strong>Должность:</strong> ${escapeHtml(request.position)}</p>` : ''}
                            <p><strong>Телефон:</strong> ${request.phone}</p>
                            <p><strong>Email:</strong> ${request.email}</p>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--oil-dark); margin-bottom: 10px; border-bottom: 2px solid var(--oil-light); padding-bottom: 5px;">
                                <i class="fas fa-info-circle" style="color: var(--oil-gold); margin-right: 8px;"></i>
                                Детали
                            </h4>
                            <p><strong>Тип заявки:</strong> ${isDemo ? 'Демонстрация' : 'Поддержка'}</p>
                            <p><strong>Дата:</strong> ${formattedDate}</p>
                            ${isDemo && request.users_count ? `<p><strong>Пользователей:</strong> ${escapeHtml(request.users_count)}</p>` : ''}
                            ${isDemo && request.system_type ? `<p><strong>Система:</strong> ${escapeHtml(request.system_type)}</p>` : ''}
                            ${!isDemo && request.system_type ? `<p><strong>Используемая система:</strong> ${escapeHtml(request.system_type)}</p>` : ''}
                        </div>
                    </div>
                `;
                
                // Добавляем сообщение если есть
                if (request.message || request.problem_description) {
                    const message = request.message || request.problem_description;
                    detailsHTML += `
                        <div style="margin-top: 20px;">
                            <h4 style="color: var(--oil-dark); margin-bottom: 10px; border-bottom: 2px solid var(--oil-light); padding-bottom: 5px;">
                                <i class="fas fa-comment" style="color: var(--oil-gold); margin-right: 8px;"></i>
                                ${isDemo ? 'Сообщение' : 'Описание проблемы'}
                            </h4>
                            <div style="background: var(--oil-light); padding: 15px; border-radius: 8px; line-height: 1.6;">
                                ${escapeHtml(message).replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    `;
                }
                
                // Добавляем действия
                detailsHTML += `
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: center;">
                        <button id="callBtn" class="btn btn-primary" style="margin: 5px;">
                            <i class="fas fa-phone"></i> Позвонить
                        </button>
                        <button id="emailBtn" class="btn btn-primary" style="margin: 5px;">
                            <i class="fas fa-envelope"></i> Написать
                        </button>
                        <button id="closeBtn" class="btn btn-secondary" style="margin: 5px;">
                            <i class="fas fa-times"></i> Закрыть
                        </button>
                    </div>
                `;
                
                detailContent.innerHTML = detailsHTML;
                requestDetails.style.display = 'block';
                
                // Прокручиваем к деталям
                requestDetails.scrollIntoView({ behavior: 'smooth' });
                
                // Добавляем обработчики кнопок в деталях
                setTimeout(() => {
                    const callBtn = document.getElementById('callBtn');
                    const emailBtn = document.getElementById('emailBtn');
                    const closeBtn = document.getElementById('closeBtn');
                    
                    if (callBtn) {
                        callBtn.addEventListener('click', () => {
                            window.location.href = `tel:${request.phone}`;
                        });
                    }
                    
                    if (emailBtn) {
                        emailBtn.addEventListener('click', () => {
                            window.location.href = `mailto:${request.email}`;
                        });
                    }
                    
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => {
                            requestDetails.style.display = 'none';
                        });
                    }
                }, 100);
            }
        }
        
        // Функция подтверждения удаления
        function showConfirmDelete(index, type) {
            const requests = JSON.parse(localStorage.getItem(`sync_${type}_requests`) || '[]');
            
            if (index >= 0 && index < requests.length) {
                const request = requests[index];
                const isDemo = type === 'demo';
                
                document.getElementById('confirmTitle').textContent = 'Удаление заявки';
                document.getElementById('confirmMessage').textContent = 
                    `Вы уверены, что хотите удалить заявку от ${request.full_name || request.name} (${request.company})?`;
                
                confirmModal.style.display = 'flex';
                
                // Обработчики кнопок модального окна
                const cancelBtn = document.getElementById('confirmCancelBtn');
                const okBtn = document.getElementById('confirmOkBtn');
                
                const cancelHandler = () => {
                    confirmModal.style.display = 'none';
                    cancelBtn.removeEventListener('click', cancelHandler);
                    okBtn.removeEventListener('click', okHandler);
                };
                
                const okHandler = () => {
                    deleteRequest(index, type);
                    confirmModal.style.display = 'none';
                    cancelBtn.removeEventListener('click', cancelHandler);
                    okBtn.removeEventListener('click', okHandler);
                };
                
                cancelBtn.addEventListener('click', cancelHandler);
                okBtn.addEventListener('click', okHandler);
            }
        }
        
        // Функция удаления заявки
        function deleteRequest(index, type) {
            const key = `sync_${type}_requests`;
            let requests = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (index >= 0 && index < requests.length) {
                requests.splice(index, 1);
                localStorage.setItem(key, JSON.stringify(requests));
                loadAllRequests(); // Перезагружаем таблицу
                
                // Показываем уведомление
                showNotification(`Заявка удалена`, 'success');
            }
        }
        
        // Функция экспорта данных
        function exportToExcel() {
            const demoRequests = JSON.parse(localStorage.getItem('sync_demo_requests') || '[]');
            const supportRequests = JSON.parse(localStorage.getItem('sync_support_requests') || '[]');
            
            const data = {
                demo_requests: demoRequests,
                support_requests: supportRequests,
                export_date: new Date().toISOString(),
                total_count: demoRequests.length + supportRequests.length
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `sync_requests_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Данные экспортированы в JSON файл', 'success');
        }
        
        // Функция импорта данных
        function importFromJson(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Проверяем структуру данных
                    if (!data.demo_requests || !data.support_requests) {
                        throw new Error('Неверный формат файла');
                    }
                    
                    // Подтверждение перед импортом
                    document.getElementById('confirmTitle').textContent = 'Импорт данных';
                    document.getElementById('confirmMessage').textContent = 
                        `Импортировать ${data.demo_requests.length} демо-заявок и ${data.support_requests.length} обращений в поддержку? Существующие данные будут сохранены.`;
                    
                    confirmModal.style.display = 'flex';
                    
                    const cancelBtn = document.getElementById('confirmCancelBtn');
                    const okBtn = document.getElementById('confirmOkBtn');
                    
                    const cancelHandler = () => {
                        confirmModal.style.display = 'none';
                        cancelBtn.removeEventListener('click', cancelHandler);
                        okBtn.removeEventListener('click', okHandler);
                    };
                    
                    const okHandler = () => {
                        // Загружаем существующие данные
                        const existingDemo = JSON.parse(localStorage.getItem('sync_demo_requests') || '[]');
                        const existingSupport = JSON.parse(localStorage.getItem('sync_support_requests') || '[]');
                        
                        // Объединяем с новыми (уникальные по email и дате)
                        const mergeRequests = (existing, newItems) => {
                            const combined = [...existing];
                            
                            newItems.forEach(newItem => {
                                // Проверяем, нет ли уже такой заявки
                                const exists = existing.some(existingItem => 
                                    existingItem.email === newItem.email && 
                                    existingItem.timestamp === newItem.timestamp
                                );
                                
                                if (!exists) {
                                    combined.push(newItem);
                                }
                            });
                            
                            return combined;
                        };
                        
                        // Сохраняем объединённые данные
                        localStorage.setItem('sync_demo_requests', JSON.stringify(
                            mergeRequests(existingDemo, data.demo_requests)
                        ));
                        
                        localStorage.setItem('sync_support_requests', JSON.stringify(
                            mergeRequests(existingSupport, data.support_requests)
                        ));
                        
                        confirmModal.style.display = 'none';
                        loadAllRequests(); // Перезагружаем таблицу
                        
                        showNotification('Данные успешно импортированы', 'success');
                        
                        cancelBtn.removeEventListener('click', cancelHandler);
                        okBtn.removeEventListener('click', okHandler);
                    };
                    
                    cancelBtn.addEventListener('click', cancelHandler);
                    okBtn.addEventListener('click', okHandler);
                    
                } catch (error) {
                    showNotification(`Ошибка импорта: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        // Функция очистки всех данных
        function clearAllData() {
            document.getElementById('confirmTitle').textContent = 'Очистка всех данных';
            document.getElementById('confirmMessage').textContent = 
                'Вы уверены, что хотите удалить ВСЕ заявки? Это действие нельзя отменить.';
            
            confirmModal.style.display = 'flex';
            
            const cancelBtn = document.getElementById('confirmCancelBtn');
            const okBtn = document.getElementById('confirmOkBtn');
            
            const cancelHandler = () => {
                confirmModal.style.display = 'none';
                cancelBtn.removeEventListener('click', cancelHandler);
                okBtn.removeEventListener('click', okHandler);
            };
            
            const okHandler = () => {
                localStorage.removeItem('sync_demo_requests');
                localStorage.removeItem('sync_support_requests');
                confirmModal.style.display = 'none';
                loadAllRequests(); // Перезагружаем таблицу
                
                showNotification('Все данные удалены', 'success');
                
                cancelBtn.removeEventListener('click', cancelHandler);
                okBtn.removeEventListener('click', okHandler);
            };
            
            cancelBtn.addEventListener('click', cancelHandler);
            okBtn.addEventListener('click', okHandler);
        }
        
        // Функция показа уведомления
        function showNotification(message, type = 'info') {
            // Удаляем старые уведомления
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Стили уведомления
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--oil-green)' : type === 'error' ? 'var(--oil-fire)' : 'var(--oil-blue)'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                z-index: 1000;
                display: flex;
                justify-content: space-between;
                align-items: center;
                min-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            document.body.appendChild(notification);
            
            // Кнопка закрытия
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.style.cssText = `
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                font-size: 1.2rem;
                margin-left: 15px;
                opacity: 0.8;
            `;
            
            closeBtn.addEventListener('click', () => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            });
            
            // Автоматическое скрытие
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }
        
        // Функция экранирования HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ===== Обработчики событий =====
        
        // Экспорт
        exportBtn.addEventListener('click', exportToExcel);
        
        // Импорт
        importBtn.addEventListener('click', () => {
            importModal.style.display = 'flex';
        });
        
        importCancelBtn.addEventListener('click', () => {
            importModal.style.display = 'none';
            importFileInput.value = '';
        });
        
        importFileBtn.addEventListener('click', () => {
            if (importFileInput.files.length > 0) {
                importFromJson(importFileInput.files[0]);
                importModal.style.display = 'none';
                importFileInput.value = '';
            } else {
                showNotification('Выберите файл для импорта', 'error');
            }
        });
        
        // Очистка
        clearBtn.addEventListener('click', clearAllData);
        
        // Обновление
        refreshBtn.addEventListener('click', () => {
            loadAllRequests();
            showNotification('Таблица обновлена', 'info');
        });
        
        // Закрытие деталей
        closeDetailsBtn.addEventListener('click', () => {
            requestDetails.style.display = 'none';
        });
        
        // Закрытие модального окна по клику вне его
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal) {
                confirmModal.style.display = 'none';
            }
        });
        
        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                importModal.style.display = 'none';
                importFileInput.value = '';
            }
        });
        
        // Закрытие деталей по ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (requestDetails.style.display === 'block') {
                    requestDetails.style.display = 'none';
                }
                if (confirmModal.style.display === 'flex') {
                    confirmModal.style.display = 'none';
                }
                if (importModal.style.display === 'flex') {
                    importModal.style.display = 'none';
                    importFileInput.value = '';
                }
            }
        });
        
        // Инициализация при загрузке
        loadAllRequests();
        
        // Добавляем CSS анимации
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
            
            .requests-table {
                width: 100%;
                border-collapse: collapse;
                background: white;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            }
            
            .requests-table thead {
                background: linear-gradient(135deg, var(--oil-dark), #1a365d);
            }
            
            .requests-table th {
                padding: 15px;
                text-align: left;
                color: white;
                font-weight: 600;
                border-bottom: 2px solid var(--oil-gold);
            }
            
            .requests-table td {
                padding: 15px;
                border-bottom: 1px solid #eee;
            }
            
            .requests-table tr:last-child td {
                border-bottom: none;
            }
            
            .requests-table tbody tr:hover {
                background: var(--oil-light);
                transition: background 0.3s;
            }
            
            .btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                text-decoration: none;
            }
            
            .btn-primary {
                background: var(--oil-blue);
                color: white;
            }
            
            .btn-primary:hover {
                background: #2563eb;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            }
            
            .btn-secondary {
                background: var(--oil-steel);
                color: white;
            }
            
            .btn-secondary:hover {
                background: #4b5563;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(75, 85, 99, 0.3);
            }
            
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1001;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .modal-content {
                background: white;
                border-radius: 12px;
                padding: 30px;
                max-width: 90%;
                animation: slideUp 0.3s ease-out;
            }
            
            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .view-btn, .delete-btn {
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.8rem;
                transition: all 0.3s;
            }
            
            .view-btn:hover, .delete-btn:hover {
                transform: scale(1.1);
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
        `;
        document.head.appendChild(style);
        
        console.log('Система заявок инициализирована');
    });
    </script>
</body>
</html>